name: LLM Security Guard

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©UTC 02:00è¿è¡Œä¸€æ¬¡
    - cron: '0 2 * * *'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ‰«æ
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        # å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆä»…æµ‹è¯•éœ€è¦çš„éƒ¨åˆ†ï¼‰
        pip install pyyaml pathlib
    
    - name: Run sensitive data scan
      run: |
        echo "ğŸ” æ‰«ææ•æ„Ÿæ•°æ®..."
        python -m pytest tests/test_no_keys_committed.py -v
    
    - name: Run additional security checks
      run: |
        echo "ğŸ”’ æ‰§è¡Œé¢å¤–å®‰å…¨æ£€æŸ¥..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†ç 
        echo "æ£€æŸ¥ç¡¬ç¼–ç å¯†ç ..."
        if grep -r -i "password\s*=\s*['\"][^'\"]*['\"]" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md"; then
          echo "âŒ å‘ç°ç¡¬ç¼–ç å¯†ç "
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰TODOæ ‡è®°çš„å®‰å…¨é—®é¢˜
        echo "æ£€æŸ¥å®‰å…¨TODOé¡¹..."
        if grep -r -i "TODO.*security\|FIXME.*security\|XXX.*security" . --exclude-dir=.git --exclude-dir=node_modules; then
          echo "âš ï¸ å‘ç°å®‰å…¨ç›¸å…³çš„TODOé¡¹ï¼Œè¯·åŠæ—¶å¤„ç†"
        fi
        
        # æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶æ˜¯å¦è¢«æ„å¤–æäº¤
        echo "æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶..."
        sensitive_files=(
          ".env"
          "*.key"
          "*.pem" 
          "*.p12"
          "*.pfx"
          "id_rsa"
          "id_dsa"
          "credentials.json"
          "service-account.json"
        )
        
        for pattern in "${sensitive_files[@]}"; do
          if find . -name "$pattern" -not -path "./.git/*" | grep -q .; then
            echo "âŒ å‘ç°æ•æ„Ÿæ–‡ä»¶: $pattern"
            find . -name "$pattern" -not -path "./.git/*"
            exit 1
          fi
        done
        
        echo "âœ… é¢å¤–å®‰å…¨æ£€æŸ¥é€šè¿‡"
    
    - name: Check .gitignore coverage
      run: |
        echo "ğŸ›¡ï¸ æ£€æŸ¥ .gitignore è¦†ç›–..."
        
        required_patterns=(
          ".env"
          "*.key"
          "*.pem"
          "secrets/"
          "credentials/"
          "*.log"
          "__pycache__/"
        )
        
        missing_patterns=()
        
        for pattern in "${required_patterns[@]}"; do
          if ! grep -q "$pattern" .gitignore 2>/dev/null; then
            missing_patterns+=("$pattern")
          fi
        done
        
        if [ ${#missing_patterns[@]} -gt 0 ]; then
          echo "âš ï¸ .gitignore ç¼ºå°‘ä»¥ä¸‹æ¨¡å¼:"
          printf '%s\n' "${missing_patterns[@]}"
          echo "å»ºè®®æ·»åŠ åˆ° .gitignore æ–‡ä»¶ä¸­"
        else
          echo "âœ… .gitignore è¦†ç›–æ£€æŸ¥é€šè¿‡"
        fi
    
    - name: Scan commit history (last 10 commits)
      run: |
        echo "ğŸ“œ æ‰«ææœ€è¿‘æäº¤å†å²..."
        
        # è·å–æœ€è¿‘10æ¬¡æäº¤çš„diff
        commits=$(git log --oneline -10 --format="%H")
        
        violation_found=false
        
        for commit in $commits; do
          echo "æ£€æŸ¥æäº¤: $commit"
          
          # è·å–æäº¤çš„diffå†…å®¹
          diff_content=$(git show --format="" --name-only $commit)
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿæ–‡ä»¶è¢«æ·»åŠ 
          if echo "$diff_content" | grep -E "\.(key|pem|p12|pfx)$|^\.env$|credentials|secrets"; then
            echo "âŒ æäº¤ $commit åŒ…å«æ•æ„Ÿæ–‡ä»¶"
            git show --stat $commit
            violation_found=true
          fi
        done
        
        if [ "$violation_found" = true ]; then
          echo "âŒ å‘ç°å†å²æäº¤ä¸­çš„æ•æ„Ÿä¿¡æ¯"
          exit 1
        else
          echo "âœ… æäº¤å†å²æ£€æŸ¥é€šè¿‡"
        fi
    
    - name: Generate security report
      if: always()
      run: |
        echo "ğŸ“Š ç”Ÿæˆå®‰å…¨æŠ¥å‘Š..."
        
        report_file="security_report.md"
        
        cat > $report_file << 'EOF'
        # ğŸ”’ MAO-Wise å®‰å…¨æ‰«ææŠ¥å‘Š
        
        **æ‰«ææ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **æäº¤**: ${{ github.sha }}
        
        ## æ‰«æèŒƒå›´
        
        - âœ… æ•æ„Ÿæ•°æ®æ¨¡å¼æ£€æµ‹
        - âœ… APIå¯†é’¥æ³„éœ²æ£€æµ‹  
        - âœ… ç¡¬ç¼–ç å¯†ç æ£€æµ‹
        - âœ… æ•æ„Ÿæ–‡ä»¶æ£€æµ‹
        - âœ… .gitignore è¦†ç›–æ£€æŸ¥
        - âœ… æäº¤å†å²æ‰«æ
        
        ## æ£€æµ‹æ¨¡å¼
        
        | ç±»å‹ | æ¨¡å¼ | ä¸¥é‡ç¨‹åº¦ |
        |------|------|----------|
        | OpenAI API Key | `sk-[a-zA-Z0-9]{20,}` | Critical |
        | Azure API Key | `[a-f0-9]{32}` | High |
        | Generic API Key | `api[_-]?key.*[a-zA-Z0-9+/=]{20,}` | High |
        | Bearer Token | `Bearer\s+[a-zA-Z0-9\-._~+/]+=*` | Medium |
        | JWT Token | `eyJ[a-zA-Z0-9\-._~+/]+=*\.eyJ.*` | Medium |
        | Private Key | `-----BEGIN.*PRIVATE.*KEY-----` | Critical |
        | AWS Access Key | `AKIA[0-9A-Z]{16}` | Critical |
        
        ## å®‰å…¨å»ºè®®
        
        1. **æ°¸è¿œä¸è¦æäº¤çœŸå®çš„APIå¯†é’¥**
        2. **ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯**
        3. **å®šæœŸè½®æ¢APIå¯†é’¥**
        4. **ä½¿ç”¨ .env.example ä½œä¸ºé…ç½®æ¨¡æ¿**
        5. **å¯ç”¨GitHub Secret Scanning**
        
        ---
        *æ­¤æŠ¥å‘Šç”± MAO-Wise LLM Security Guard è‡ªåŠ¨ç”Ÿæˆ*
        EOF
        
        echo "ğŸ“‹ å®‰å…¨æŠ¥å‘Šå·²ç”Ÿæˆ"
        cat $report_file
    
    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security_report.md
        retention-days: 30
    
    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš¨ **å®‰å…¨æ‰«æå¤±è´¥**
            
            æ­¤ PR åŒ…å«æ•æ„Ÿä¿¡æ¯æˆ–å®‰å…¨é£é™©ã€‚è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š
            
            - ç¡®ä¿æ²¡æœ‰æäº¤çœŸå®çš„APIå¯†é’¥
            - æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†ç 
            - éªŒè¯æ•æ„Ÿæ–‡ä»¶æ˜¯å¦æ­£ç¡®æ·»åŠ åˆ° .gitignore
            
            è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ Actions æ—¥å¿—ã€‚`
          })
    
  dependency-scan:
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'  # å®šæ—¶ä»»åŠ¡è·³è¿‡ä¾èµ–æ‰«æ
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install safety
      run: |
        pip install safety
    
    - name: Run safety check
      run: |
        echo "ğŸ” æ£€æŸ¥Pythonä¾èµ–å®‰å…¨æ€§..."
        if [ -f "requirements.txt" ]; then
          safety check -r requirements.txt --json > safety_report.json || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é«˜é£é™©æ¼æ´
          if [ -f "safety_report.json" ]; then
            vulnerabilities=$(cat safety_report.json | python -c "
            import sys, json
            try:
                data = json.load(sys.stdin)
                if isinstance(data, list) and len(data) > 0:
                    high_risk = [v for v in data if 'vulnerability' in str(v).lower()]
                    print(len(high_risk))
                else:
                    print(0)
            except:
                print(0)
            ")
            
            if [ "$vulnerabilities" -gt 0 ]; then
              echo "âŒ å‘ç° $vulnerabilities ä¸ªå®‰å…¨æ¼æ´"
              cat safety_report.json
              exit 1
            else
              echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"
            fi
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ° requirements.txt æ–‡ä»¶"
        fi
